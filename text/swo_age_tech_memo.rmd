---
title: "Estimating age and length composition input sample sizes for stocks assessed with statistical catch-at-age models at AFSC"

author: 
# alpha order for now
  - name: Meaghan Bryan
    institute: afscsearefm
  - name: Jason Conner
    institute: afscsearace
  - name: Pete Hulson
    institute: afscjnu
    email: pete.hulson@noaa.gov
    correspondence: true
  - name: Matthew Siskey
    institute: uw
  - name: Benjamin Williams
    institute: afscjnu    

institute:
  - afscjnu: Auke Bay Laboratories, Alaska Fisheries Science Center, National Marine Fisheries Service, National Oceanic and Atmospheric Administration, 17109 Point Lena Loop Rd., Juneau, AK 99801
  - afscsearefm: Resource Ecology and Fisheries Management Division, Alaska Fisheries Science Center, National Marine Fisheries Service, National Oceanic and Atmospheric Administration, 7600 Sand Point Way NE, Seattle, WA 98115
  - afscsearace: Resource Assessment and Conservation Engineering Division, Alaska Fisheries Science Center, National Marine Fisheries Service, National Oceanic and Atmospheric Administration, 7600 Sand Point Way NE, Seattle, WA 98115
  - uw: School of Aquatic and Fishery Sciences, University of Washington, Seattle, WA, USA


output:
  bookdown::word_document2:
    toc: false
    number_sections: false
    reference_docx: styles_reference.docx
    pandoc_args:  
      - '--lua-filter=scholarly-metadata.lua'
      - '--lua-filter=author-info-blocks.lua'
 

bibliography: refs.bib   
csl: canjfas.csl

header-includes:
  - \usepackage(amsmath) # for cases in equations
  - \usepackage{booktabs}
  - \usepackaee{cleveref}

  - \renewcommand{\eqref}{\Cref}
  - \Crefformat{equation}{#2#1#3}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, error = FALSE)
source(here::here('R', "render_toc.R"))
```

\newpage

# Abstract 

[Pete and Matt]


\newpage

```{r toc}
render_toc("swo_age_tech_memo.Rmd")
```

\newpage

# Introduction 

[General para on use of age and length comp data in AFSC assessments - Pete]

[General para on age & length sampling in AFSC bottom trawl surveys - Jason]

[General para on effective sample size and estimating input sample size - Matt]

[Objective para - Pete]


# Materials and Methods 

## Survey data 

Data collection for each AFSC groundfish survey is described in respective NOAA Technical Memorandum [EBS: @Lauth2019; AI: @vonSzalay2017; GOA: @vonSzalay2018].
Length frequency protocols and recent analysis of historical data are further described in @Hulson2022.

[Some further detail on age sampling - Jason]

Species within each survey that are assessed with statistical catch-at-age models (Tier 3 and above stock assessments) were selected to be included in this analysis. 

[Tables of annual raw sample sizes for length and age with some description - Meaghan]

The database (i.e., RACEBASE) was queried based on functions used in the sumfish package in Program R (https://github.com/afsc-gap-products/sumfish). 

## Expanding length frequency to population abundance at length

Length frequency samples collected by the AFSC bottom trawl surveys are expanded by catch and stratum area to obtain estimates of population abundance at length. 
This is often referred to as the ‘first stage expansion’ and is a common method to obtain population estimates at length from area-swept survey data [e.g., @Ailloud2019, @Miller2006]. 
Population abundance at length are computed for three sex categories: males, females, and unsexed at the stratum level, which are then summed across stratum to obtain the population abundance at length for the management-scale region (i.e., EBS, AI, or GOA), these can also be summed to any sub-region level.

In the first step of this process we compute the overall population numbers in year-*y* within stratum-*st* ($\hat{N}_{st,y}$) with:

\begin{equation}
 \hat{N}_{st,y}=\overline{CPUE}_{st,y}\cdot A_{st}
  (\#eq:eqn1)
\end{equation}

where $A_{st}$ is the area of stratum-*st* (in km^2^), and $\overline{CPUE}_{st,y}$ is the average catch per unit effort of numbers captured across the hauls within a strata, given by:

\begin{equation}
 \overline{CPUE}_{st,y}
  =\frac{1}{H_{st,y}}\sum_{h=1}^{H_{st,y}}CPUE_{h,st,y}
  =\frac{1}{H_{st,y}}\sum_{h=1}^{H_{st,y}}\frac{n_{h,st,y}}{E_{h,st,y}}
  (\#eq:eqn2)
\end{equation}

where $H_{st,y}$ is the number of hauls, $CPUE_{h,st,y}$ is the catch per unit effort of numbers caught within a haul-*h*, $n_{h,st,y}$ is the catch (in numbers) in haul-*h*, and $E_{h,st,y}$ is the effort in haul-*h*, which is computed as the net width multiplied by the time on bottom, or, the area swept by the haul (in km^2^). 
Next, the ratio of catch per unit effort among hauls ($\hat{p}_{CPUE,h,st,y}$) is computed by:

\begin{equation}
\hat{p}_{CPUE,h,st,y}=\frac{CPUE_{h,st,y}}{\sum_{h=1}^{H_{sy,y}}CPUE_{h,st,y}}
  (\#eq:eqn3)
\end{equation}

where $CPUE_{h,st,y}$ is the catch per unit effort of numbers caught within a haul-*h*. We then compute the sex-specific ratio of the total number of lengths sampled within a haul by length ($\hat{p}_{sx,l,h,st,y}$) with:

\begin{equation}
 \hat{p}_{sx,l,h,st,y} = 
  \begin{cases}
    (1) \frac{N_{sx,l,h,st,y}}{N_{h,st,y}}  \\
    (2) \frac{\sum_{h=1}^{H_{st,y}}[N_{sx,l,h,st,y}/N_{h,st,y}]}{\sum_{sx=1}^{3}\sum_{l=1}^{L}\sum_{h=1}^{H_{st,y}}[N_{sx,l,h,st,y}/N_{h,st,y}]}
  \end{cases}
  (\#eq:eqn4)
\end{equation}

where $N_{sx,l,h,st,y}$ is the length frequency sampled, in numbers, by sex-*sx* and length-*l*. 
In some cases there are hauls that have catch for a species but did not collect length frequency data, in this case (2) is applied in order to account for the unknown length frequency in these hauls, otherwise, if length frequency samples are obtained (1) is applied. 
Finally, we estimate the sex-specific population abundance at length within strata-st with:

\begin{equation}
 \hat{N}_{sx,l,st,y}=\hat{N}_{st,y}\cdot\hat{p}_{CPUE,h,st,y}\cdot\hat{p}_{sx,l,h,st,y}
  (\#eq:eqn5)
\end{equation}

and to obtain the sex-specific estimates of population abundance at length in a management area one would simply sum $\hat{N}_{sx,l,st,y}$ across strata.

## Expanding specimen collections to population abundance at age

[Pete and Matt]


## Bootstrap-simulation framework  

[Ben and Pete - leaving what we had to build upon]

To evaluate the effect of sub-sampling length frequency collections for which sex is subsequently determined we developed a bootstrap-simulation framework that allowed for reductions in the number of sexed length frequencies collected.
We used the historical length frequency data that were collected from the bottom trawl surveys to evaluate the impact of reduced sex-specific length frequency data. 
In simple terms, the simulation framework that we developed would select a pre-determined number of fish from the length frequency collections that would then be subsequently sexed, the remaining length frequency data (regardless of whether sex was actually determined in the historical data) was classified as ‘unsexed’. 

The bootstrap-simulation framework is composed of a suite of nested resampling protocols. 
Bootstrap resampling was performed either with replacement (wr) or without replacement (wor) depending on the needs of a particular protocol. 
Functions to run the sampling protocols were developed in a compartmentalized manner to provide for substantial flexibility in exploring desired resampling protocols. 
The order of operations (Figure \@ref(fig:length)) has the following schedule, with steps 1-3 being optional switches:

1. Resample hauls (wr) from the set of hauls with associated catch per unit effort (in numbers) 
2. Within the resampled hauls from step 1, resample the observed lengths (wr)
3. From the resampled lengths in step 2, subset the lengths (wor) with observed sex (either male or female) and sample these sex-length pairs at the sub-sampling level determined in step 2; equation \@ref(eq:eqn6)
4. Calculate sex-specific population abundance at length, using equations \@ref(eq:eqn1) - \@ref(eq:eqn5)

The core of the bootstrap-simulation function (step 3 above) is designed to explore reductions in the sample size of lengths that are then sexed on a per haul basis. 
In this bootstrap-simulation, the number of lengths in a given haul must be less than or equal to the desired sample size *x* determined in step 2. In step 3, when the number of resampled lengths from step 2 in a haul $n_l$ is less than *x* then $n_l$ is used directly, if $n_l>x$ then a random draw of lengths is taken without replacement in step 3.

<!-- 1. reduce total number of length samples - wor  -->
<!-- 2. shuffle hauls - wr  -->
<!-- 3. shuffle lengths - wr  -->
<!-- 4. shuffle age data - wr -->
<!-- 5. resample lengths - wor  -->
<!-- 6. calculate length composition  -->
<!-- 7. calculate population abundance at length, using the results of step 6  -->
<!-- 8. calculate population abundance at age, using results of step 7 -->
<!-- 10. calculate effective samples size for ages and lengths, using results of step 7 and 8 -->

\begin{equation}
 l_{x} = 
  \begin{cases}
    n_l    & n_l\le x  \\
    n_{lx} & n_l > x, ~ wor
  \end{cases}
  (\#eq:eqn6)
\end{equation}

The bootstrap-simulation then repeated steps 1-3 iteratively for each sex sub-sample size determined in step 1, providing iterated sex-specific population abundance at length that was then compared to the historical sex-specific population abundance at length determined by the bottom trawl surveys.

We applied the bootstrap-simulation to species that were most commonly captured in the EBS, AI, and GOA bottom trawl surveys (Tables \@ref(tab:ai-avg-samples) - \@ref(tab:goa-avg-samples)). 
The sub-sample levels that we evaluated for subsequent sex determination from the length frequency collections were 50, 75, 100, 125, 150, and 175 samples. 
We also ran the bootstrap-simulation for the historical number of sexed length frequency collections without subsetting in order to compare the base level uncertainty to the increase in uncertainty gained through sub-sampling. 
We ran the bootstrap-simulation for 500 iterations, which was a level for which the variability in population abundance at length results had stabilized, and applied the bootstrap-simulation to the most recent 3 years of the respective bottom trawl surveys, which were the most indicative of the current sampling levels. 
The bootstrap-simulation was developed in R [@Rcore] and is available via GitHub as an R package (https://github.com/BenWilliams-NOAA/swo).

## Computing input sample size

[Matt and Pete - leaving what we had to build upon]

Effective sample size, as introduced by @Mcallister1997, is a statistic that can evaluate the level of intra-haul correlation in composition samples that are collected on a survey (whether from age or length frequency collections). 
It is also a statistic that can evaluate the amount of uncertainty in an estimated composition compared to an observed composition. 
Effective sample size is given by:

\begin{equation}
 ESS=\frac{\sum_{c=1}^{C}E_c(1-E_c)}{\sum_{c=1}^{C}(E_c-O_c)^2}
 (\#eq:eqn7)
\end{equation}

where $E_c$ is the estimated proportion for category-*c* (which can be either age or length or any other arbitrary category across which proportions are computed) and $O_c$ is the observed proportion.
 
In this bootstrap-simulation the underlying length composition derived from the historical bottom trawl surveys was treated as the observed proportions $O_c$ in equation \@ref(eq:eqn7). 
For each iteration of the bootstrap simulation for a determined sex sub-sample size we computed a sex-specific estimated proportion ($E_c$) that was then compared to the underlying historical sex-specific length composition (the effective sample size for the total length composition, as the sum of population abundance at length, was also computed). 
Thus, across each iteration of the bootstrap simulation we computed an effective sample size that indicated the amount of increased uncertainty that was caused by sub-sampling sexed length frequency data. 
To summarize effective sample size across iterations we used the harmonic mean, which has been shown to reduce bias in recovering the true sample size in simulations for a multinomial distribution. 
Due to this reduction in bias the harmonic mean has also been recommended to determine the ‘input sample size’ that is used in stock assessment models to fit compositional data [@Stewart2014]. 
Herein, when we use the term ‘effective sample size’ we are referring to the effective sample sizes that were computed for each iteration of the bootstrap-simulation, when we use the term ‘input sample size’ we are referring to the harmonic mean of the iterated effective sample sizes. 

# Results 

[Para on length input sample size results - Ben, Meaghan, and Pete]

[Para on age input sample size results - Ben, Meaghan, and Pete]

# Discussion

[General para on main take-home results - Pete]

[Para on use of input sample sizes used in assessment, with examples from other regions (e.g., west coast, iphc) - Matt]

[Conclusion para on where input sample size will be available to authors - Pete]

\newpage

# Acknowledgments

We thank *reviewer1* and *reviewer2* for their helpful reviews of this manuscript. 

\newpage

# Citations

<div id="refs"></div>

\newpage

# Tables 

[Need to discuss what level of detail to include - do we want tables for each stock individually, or, refer to some storage location in the afsc repo? - kept this table in as place holder]

```{r ai-avg-samples}
knitr::kable(vroom::vroom(here::here('tables', 'ai_samples.csv')), caption = "Total length frequency samples from the most recent three Aleutian Islands surveys for the species evaluated in the bootstrap-simulation for reduction in sexed length-frequency collections.", align = c('lcccc'), format.args = list(big.mark = ",", scientific = FALSE))
```
\newpage



# Figures 

[Will figure out what figures to include - pun intended, left length flowchart here as we will have the total flowchart included]

```{r length, fig.cap="Bootstrap-simulation flow chart, the steps refer to the order of operations as described in the *Bootstrap-simulation framework* section."}
knitr::include_graphics(here::here('figs', 'length_flowchart.png'))
```







